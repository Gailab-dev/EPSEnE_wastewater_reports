# REQ003 혐기조 예측 모델 가이드

**작성일**: 2025-11-21
**모델 ID**: REQ003
**버전**: v1.0

---

## 📋 목차

1. [모델 개요](#모델-개요)
2. [모델 알고리즘 및 구조](#모델-알고리즘-및-구조)
3. [입력 데이터 정의](#입력-데이터-정의)
4. [입력 데이터 전처리 과정](#입력-데이터-전처리-과정)
5. [출력 데이터 정의](#출력-데이터-정의)
6. [모델 사용 방법](#모델-사용-방법)
7. [성능 지표](#성능-지표)

---

## 모델 개요

### 목적
하수처리시설 **혐기조(Anaerobic Tank)의 운영 상태를 예측**하여 인 제거 효율 최적화 및 공정 안정화를 지원합니다.

### 핵심 특징
- **Multi-Output 예측**: 혐기조 주요 지표를 단일 모델로 동시 예측
- **시계열 데이터**: 시간당 측정 데이터 기반 예측
- **실시간 운영 지원**: 1시간 후 혐기조 상태 예측 가능
- **도메인 지식 활용**: 혐기조 공정 특성을 반영한 피처 엔지니어링

### 주요 사양
| 항목 | 상세 |
|------|------|
| **모델 타입** | XGBoost Multi-Output Regression |
| **예측 대상** | 혐기조 인 방출량, 혐기조 pH, 혐기조 DO |
| **예측 시점** | t 시점 데이터로 t+1 시점 예측 (1시간 후) |
| **입력 피처** | 약 50개 (유입수 데이터 + 혐기조 운전 데이터 + 시간 피처 + 도메인 피처) |
| **학습 데이터** | 2024년 시간당 데이터 (약 8,000개 샘플) |
| **목표 성능** | R² ≥ 0.85, MAPE ≤ 15% |

---

## 모델 알고리즘 및 구조

### 1. 알고리즘: XGBoost Multi-Output Regression

#### XGBoost (eXtreme Gradient Boosting)
- **타입**: Gradient Boosting Decision Tree 기반 앙상블 모델
- **특징**:
  - 높은 예측 정확도
  - 병렬 처리로 빠른 학습 속도
  - 정규화 기능으로 과적합 방지
  - 결측치 자동 처리

#### Multi-Output Wrapper
- `sklearn.multioutput.MultiOutputRegressor` 사용
- 3개의 독립적인 XGBoost 모델을 내부에서 학습
- 각 출력(인 방출량, pH, DO)마다 별도의 예측기 생성

### 2. 모델 구조

```
입력 데이터 (약 50개 피처)
    ↓
[전처리 레이어]
    ├─ 이상치 클리핑 (1%~99% 분위수)
    ├─ 시간 피처 생성
    ├─ 도메인 피처 생성 (인 방출 관련 비율)
    ├─ Lag 피처 생성 (24h, 168h)
    └─ Rolling 통계 생성 (24h 윈도우)
    ↓
[정규화 레이어]
    └─ StandardScaler (평균 0, 표준편차 1)
    ↓
[XGBoost Multi-Output]
    ├─ Estimator #1: 혐기조 인 방출량 예측
    ├─ Estimator #2: 혐기조 pH 예측
    └─ Estimator #3: 혐기조 DO 예측
    ↓
[역정규화 레이어]
    └─ 예측값을 원래 스케일로 복원
    ↓
출력 데이터 (3개 지표)
```

### 3. 하이퍼파라미터 (최적화 완료)

```python
xgb_params = {
    'n_estimators': 200,         # 트리 개수
    'max_depth': 4,              # 트리 최대 깊이 (과적합 방지)
    'learning_rate': 0.05,       # 학습률 (천천히 학습)
    'min_child_weight': 1,       # 리프 노드 최소 가중치
    'subsample': 0.8,            # 행 샘플링 비율 (80%)
    'colsample_bytree': 0.8,     # 열 샘플링 비율 (80%)
    'gamma': 0,                  # 분할 최소 손실 감소
    'reg_alpha': 0.1,            # L1 정규화 (Lasso)
    'reg_lambda': 1.0,           # L2 정규화 (Ridge)
    'random_state': 42,          # 재현성을 위한 시드
    'n_jobs': -1                 # 병렬 처리 (모든 CPU 사용)
}
```

### 4. 검증 전략

#### Time Series Cross-Validation (5-Fold)
```
Fold 1: [Train ████████      ] [Val ██]
Fold 2: [Train ██████████    ] [Val ██]
Fold 3: [Train ████████████  ] [Val ██]
Fold 4: [Train ██████████████] [Val ██]
Fold 5: [Train ████████████████] [Val ██]
```

- **목적**: 시계열 데이터의 시간 순서 유지
- **장점**: 모델 안정성 및 일반화 성능 검증
- **결과**: 각 타겟별 R² Mean ± Std 산출

---

## 입력 데이터 정의

### 1. 유입수 관련 변수 (6개)

| 변수명 | 단위 | 설명 | 정상 범위 |
|--------|------|------|-----------|
| `유입유량` | m³/일 | 하수처리장 유입 유량 | 50,000~200,000 |
| `유입BOD` | mg/L | 생물화학적 산소요구량 | 50~300 |
| `유입TN` | mg/L | 총 질소 농도 | 10~50 |
| `유입TP` | mg/L | 총 인 농도 | 1~10 |
| `유입TOC` | mg/L | 총 유기탄소 농도 | 20~100 |
| `유입SS` | mg/L | 부유물질 농도 | 30~300 |

### 2. 혐기조 운전 데이터 (예상 변수)

| 변수명 | 단위 | 설명 | 정상 범위 |
|--------|------|------|-----------|
| `혐기조_유입유량` | m³/일 | 혐기조 유입 유량 | - |
| `혐기조_체류시간` | hour | 수리학적 체류시간 (HRT) | 1~4 |
| `혐기조_온도` | °C | 혼합액 온도 | 10~30 |
| `혐기조_MLSS` | mg/L | 혼합액부유물질 농도 | 2,000~5,000 |
| `혐기조_유입인` | mg/L | 혐기조 유입 인 농도 | - |
| `혐기조_pH` | - | 혐기조 pH | 6.5~7.5 |
| `혐기조_DO` | mg/L | 용존산소 농도 (혐기 유지) | < 0.5 |
| `반송슬러지_비율` | % | 반송 슬러지 비율 (RAS) | 30~100 |

### 3. 시간 피처 (6개)

| 변수명 | 타입 | 설명 | 범위 |
|--------|------|------|------|
| `hour` | int | 시간 (0~23시) | 0~23 |
| `day_of_week` | int | 요일 (0=월요일, 6=일요일) | 0~6 |
| `month` | int | 월 (1~12월) | 1~12 |
| `is_weekend` | int | 주말 여부 (0=평일, 1=주말) | 0, 1 |
| `season` | int | 계절 (1=봄, 2=여름, 3=가을, 4=겨울) | 1~4 |
| `day` | int | 일자 (1~31일) | 1~31 |

**※ 주의**: `day` 변수는 모델 학습 시 제외됨 (과적합 방지)

### 4. 도메인 기반 피처 (혐기조 특화)

#### 4.1 비율 피처
| 변수명 | 계산식 | 의미 | 활용 |
|--------|--------|------|------|
| `BOD_TP_ratio` | 유입BOD / (유입TP + ε) | BOD/P 비율 | 생물학적 인 제거 잠재력 평가 |
| `TN_TP_ratio` | 유입TN / (유입TP + ε) | N/P 비율 | 영양염류 균형 |
| `MLSS_TP_ratio` | 혐기조_MLSS / (혐기조_유입인 + ε) | 미생물 대비 인 농도 | 인 흡수 효율 |
| `HRT_유량_ratio` | 혐기조_체류시간 / (혐기조_유입유량 + ε) | 체류시간 대비 부하 | 혐기조 부하 상태 |

**※ ε = 1e-10**: 0으로 나누기 방지

#### 4.2 변화율 피처
| 변수명 | 계산식 | 의미 |
|--------|--------|------|
| `유량_변화율` | (혐기조_유입유량ₜ - 혐기조_유입유량ₜ₋₁) / 혐기조_유입유량ₜ₋₁ | 유량 변동성 |
| `TP_변화율` | (유입TPₜ - 유입TPₜ₋₁) / 유입TPₜ₋₁ | 인 부하 변화 |
| `pH_변화율` | (혐기조_pHₜ - 혐기조_pHₜ₋₁) / 혐기조_pHₜ₋₁ | pH 변동성 |
| `온도_변화율` | (혐기조_온도ₜ - 혐기조_온도ₜ₋₁) / 혐기조_온도ₜ₋₁ | 온도 변화율 |

#### 4.3 부하 관련 피처
| 변수명 | 계산식 | 의미 |
|--------|--------|------|
| `인_부하` | 혐기조_유입유량 × 혐기조_유입인 × 1e-3 | 시간당 인 부하 (kg/일) |
| `MLSS_부하` | 혐기조_MLSS / 혐기조_체류시간 | 단위 체류시간당 MLSS |

### 5. Lag 피처 (예상)

**목적**: 과거 데이터 패턴 학습

| 시간 범위 | 변수 개수 | 변수 예시 |
|-----------|-----------|-----------|
| 24시간 전 (1일) | 8개 | `유입TP_lag24`, `혐기조_pH_lag24`, ... |
| 168시간 전 (1주) | 8개 | `유입TP_lag168`, `혐기조_MLSS_lag168`, ... |

**※ 개선사항**: 1시간 Lag 제거 (실시간 예측 불가능한 정보)

### 6. Rolling 통계 피처

**목적**: 최근 24시간 트렌드 파악

| 통계량 | 변수 개수 | 변수 예시 |
|--------|-----------|-----------|
| 평균 (mean) | 5개 | `혐기조_유입유량_rolling_mean24` |
| 표준편차 (std) | 5개 | `혐기조_pH_rolling_std24` |
| 최대값 (max) | 5개 | `혐기조_DO_rolling_max24` |
| 최소값 (min) | 5개 | `혐기조_온도_rolling_min24` |

**대상 변수**: 혐기조_유입유량, 혐기조_pH, 혐기조_DO, 혐기조_온도, 유입TP

### 7. 전체 피처 구성 요약

```
총 약 50개 피처
├─ 유입수 변수: 6개
├─ 혐기조 운전 변수: 8개
├─ 시간 피처: 5개 (day 제외)
├─ 도메인 피처: 6개 (비율 4개 + 변화율 4개 + 부하 2개)
├─ Lag 피처: 16개 (24h × 8개 + 168h × 8개)
└─ Rolling 피처: 20개 (4개 통계량 × 5개 변수)
```

---

## 입력 데이터 전처리 과정

### 전처리 파이프라인

```
원본 데이터 (CSV)
    ↓
[1단계] 데이터 로드 및 정제
    ├─ 헤더 행 읽기
    ├─ 단위 행 제거 (2번째 행)
    ├─ 인덱스 재설정
    ├─ 초기 결측치 제거
    └─ 데이터 타입 변환 (float)
    ↓
[2단계] 이상치 처리
    ├─ 방법: 분위수 기반 클리핑
    ├─ 범위: 1% ~ 99% 분위수
    └─ 대상: 모든 수치형 변수
    ↓
[3단계] 시간 피처 생성
    ├─ datetime 변환
    ├─ hour, day_of_week, month 추출
    ├─ is_weekend 생성 (day_of_week >= 5)
    └─ season 생성 (월 → 계절 매핑)
    ↓
[4단계] 도메인 피처 생성
    ├─ 비율 피처 (4개)
    ├─ 변화율 피처 (4개)
    └─ 부하 피처 (2개)
    ↓
[5단계] 타겟 변수 선택
    ├─ 혐기조_인방출량
    ├─ 혐기조_pH
    └─ 혐기조_DO
    ↓
[6단계] Lag 피처 생성
    ├─ 24시간 Lag (8개 변수)
    └─ 168시간 Lag (8개 변수)
    ↓
[7단계] Rolling 통계 생성
    ├─ 윈도우: 24시간
    ├─ 통계량: mean, std, max, min
    └─ 대상: 5개 변수
    ↓
[8단계] 결측치 처리
    ├─ 초기 168시간 제거 (Lag 피처 생성으로 인한 결측)
    └─ 나머지 결측치 제거 (dropna)
    ↓
[9단계] Feature/Target 분리
    ├─ 제외 컬럼: 시간, 타겟 3개, day
    └─ Feature: 약 50개, Target: 3개
    ↓
[10단계] Train/Test 분할
    ├─ 방법: 시계열 순차 분할
    ├─ 비율: Train 80% / Test 20%
    └─ Shuffle: False (시간 순서 유지)
    ↓
[11단계] 정규화
    ├─ 방법: StandardScaler
    ├─ 공식: (X - μ) / σ
    ├─ 적용: X_train, y_train으로 fit
    └─ 변환: X_test, y_test는 transform만
    ↓
학습 준비 완료
```

### 각 단계 상세 설명

#### 2단계: 이상치 처리
```python
def clip_outliers(df, columns, lower_quantile=0.01, upper_quantile=0.99):
    df_clipped = df.copy()
    for col in columns:
        lower = df[col].quantile(lower_quantile)
        upper = df[col].quantile(upper_quantile)
        df_clipped[col] = df[col].clip(lower, upper)
    return df_clipped

numeric_cols = ['혐기조_유입유량', '혐기조_pH', '혐기조_DO', '유입TP', ...]
df = clip_outliers(df, numeric_cols, lower_quantile=0.01, upper_quantile=0.99)
```

#### 4단계: 도메인 피처 생성
```python
# 비율 피처
df['BOD_TP_ratio'] = df['유입BOD'] / (df['유입TP'] + 1e-10)
df['MLSS_TP_ratio'] = df['혐기조_MLSS'] / (df['혐기조_유입인'] + 1e-10)
df['HRT_유량_ratio'] = df['혐기조_체류시간'] / (df['혐기조_유입유량'] + 1e-10)

# 변화율 피처
df['유량_변화율'] = df['혐기조_유입유량'].pct_change()
df['TP_변화율'] = df['유입TP'].pct_change()
df['pH_변화율'] = df['혐기조_pH'].pct_change()

# 부하 피처
df['인_부하'] = df['혐기조_유입유량'] * df['혐기조_유입인'] * 1e-3
df['MLSS_부하'] = df['혐기조_MLSS'] / df['혐기조_체류시간']
```

#### 6단계: Lag 피처 생성
```python
lag_features = ['유입TP', '혐기조_pH', '혐기조_DO', '혐기조_MLSS', ...]
lag_periods = [24, 168]  # 1시간 Lag 제거

for feature in lag_features:
    for lag in lag_periods:
        df[f'{feature}_lag{lag}'] = df[feature].shift(lag)
```

#### 7단계: Rolling 통계 생성
```python
rolling_features = ['혐기조_유입유량', '혐기조_pH', '혐기조_DO', '혐기조_온도', '유입TP']
window = 24

for feature in rolling_features:
    df[f'{feature}_rolling_mean24'] = df[feature].rolling(window=window).mean()
    df[f'{feature}_rolling_std24'] = df[feature].rolling(window=window).std()
    df[f'{feature}_rolling_max24'] = df[feature].rolling(window=window).max()
    df[f'{feature}_rolling_min24'] = df[feature].rolling(window=window).min()
```

---

## 출력 데이터 정의

### 1. 예측 대상 (3개)

| 변수명 | 단위 | 설명 | 정상 범위 |
|--------|------|------|-----------|
| `혐기조_인방출량` | mg/L | 혐기조에서 방출되는 인 농도 (PAOs 활동 지표) | 5~30 |
| `혐기조_pH` | - | 혐기조 pH (생물학적 인 제거 최적 범위) | 6.5~7.5 |
| `혐기조_DO` | mg/L | 용존산소 농도 (혐기 조건 유지 필수) | < 0.5 |

### 2. 출력 형식

#### Python (numpy array)
```python
# 단일 샘플 예측
y_pred = model.predict(X_new)
# 출력: [[15.6, 7.2, 0.3]]
#        [인방출량, pH, DO]

# 다중 샘플 예측
y_pred = model.predict(X_new_batch)
# 출력:
# [[15.6, 7.2, 0.3],
#  [18.2, 7.0, 0.4],
#  [12.8, 7.3, 0.2]]
```

#### JSON 형식
```json
{
  "timestamp": "2024-12-31 12:00:00",
  "predictions": {
    "혐기조_인방출량": 15.6,
    "혐기조_pH": 7.2,
    "혐기조_DO": 0.3
  },
  "unit": {
    "혐기조_인방출량": "mg/L",
    "혐기조_pH": "-",
    "혐기조_DO": "mg/L"
  },
  "model_version": "REQ003_v1.0"
}
```

### 3. 출력 데이터 해석

#### 혐기조 인 방출량
- **의미**: PAOs(Polyphosphate Accumulating Organisms)가 혐기 조건에서 방출하는 인의 양
- **활용**:
  - 생물학적 인 제거(BPR) 효율 평가
  - 호기조 인 흡수량 예측
  - 방류수 인 농도 예측

#### 혐기조 pH
- **의미**: 혐기조 내 산성도
- **활용**:
  - 미생물 활성 최적화
  - VFA(휘발성 지방산) 생성 모니터링
  - 공정 안정성 평가

#### 혐기조 DO (용존산소)
- **의미**: 혐기조 내 용존산소 농도
- **활용**:
  - 혐기 조건 유지 확인 (< 0.5 mg/L 필수)
  - PAOs 활성 보장
  - 공정 이상 감지

---

## 모델 사용 방법

### 1. 모델 로드

```python
import joblib
import pandas as pd
import numpy as np

# 저장된 모델 및 스케일러 로드
model = joblib.load('xgboost_anaerobic_model_YYYYMMDD_HHMMSS.pkl')
scaler_X = joblib.load('scaler_X_YYYYMMDD_HHMMSS.pkl')
scaler_y = joblib.load('scaler_y_YYYYMMDD_HHMMSS.pkl')
feature_cols = joblib.load('feature_cols_YYYYMMDD_HHMMSS.pkl')

print(f"✓ 모델 로드 완료")
print(f"  - 피처 수: {len(feature_cols)}개")
print(f"  - 출력 수: 3개 (혐기조 인방출량, pH, DO)")
```

### 2. 새로운 데이터 예측 (기본)

```python
# 1. 새로운 데이터 준비 (DataFrame 형식)
X_new = pd.DataFrame({
    '유입TP': [4.85],
    '혐기조_유입유량': [5000],
    '혐기조_pH': [7.0],
    # ... (모든 약 50개 피처 필요)
})

# 2. 피처 순서 맞추기
X_new_aligned = X_new[feature_cols]

# 3. 정규화
X_new_scaled = scaler_X.transform(X_new_aligned)

# 4. 예측
y_pred_scaled = model.predict(X_new_scaled)

# 5. 역정규화
y_pred = scaler_y.inverse_transform(y_pred_scaled)

# 6. 결과 출력
print(f"예측 결과:")
print(f"  혐기조 인 방출량: {y_pred[0][0]:.2f} mg/L")
print(f"  혐기조 pH: {y_pred[0][1]:.2f}")
print(f"  혐기조 DO: {y_pred[0][2]:.2f} mg/L")
```

### 3. 실시간 운영 시나리오

```python
# 실시간 운영 함수 정의
def handle_missing_realtime(df, limit=3):
    """결측치 처리: 최대 3시간까지 전방향 채우기"""
    return df.fillna(method='ffill', limit=limit)

def predict_with_fallback(model, X, y_train_history, min_lag_hours=168):
    """Cold Start 대응: Lag 피처 부족 시 평균값 사용"""
    if hasattr(X, 'columns'):
        lag_cols = [col for col in X.columns if 'lag' in col]
        if X[lag_cols].isnull().any().any():
            print("⚠️ Cold start detected - using historical average")
            return y_train_history[-min_lag_hours:].mean(axis=0)
    return model.predict(X)

def monitor_model_performance(y_true, y_pred, threshold_mape=20):
    """성능 모니터링: MAPE 20% 초과 시 재학습 필요"""
    mape = np.mean(np.abs((y_true - y_pred) / (y_true + 1e-10))) * 100
    if mape > threshold_mape:
        print(f"⚠️ Model degradation: MAPE {mape:.2f}% > {threshold_mape}%")
        return True
    return False

# 실시간 예측 워크플로우
X_new = get_latest_data()  # 실시간 데이터 수신
X_new_filled = handle_missing_realtime(X_new, limit=3)
X_new_aligned = X_new_filled[feature_cols]
X_new_scaled = scaler_X.transform(X_new_aligned)
y_pred_scaled = predict_with_fallback(model, X_new_scaled, y_train_history)
y_pred = scaler_y.inverse_transform(y_pred_scaled.reshape(1, -1))

# 결과 저장 및 전송
save_prediction(y_pred)
send_to_dashboard(y_pred)
```

---

## 성능 지표

### 1. 목표 성능

| 지표 | 목표값 | 설명 |
|------|--------|------|
| **R² Score** | ≥ 0.85 | 결정계수 (1에 가까울수록 좋음) |
| **MAPE** | ≤ 15% | 평균 절대 백분율 오차 |
| **RMSE** | 인방출량: ≤ 3 mg/L<br>pH: ≤ 0.3<br>DO: ≤ 0.1 mg/L | 평균 제곱근 오차 |

### 2. 예상 성능

| 타겟 | Train R² | Test R² | Test MAPE | Test RMSE |
|------|----------|---------|-----------|-----------|
| 혐기조 인방출량 | 0.90~0.95 | 0.85~0.90 | 8~12% | 2~3 mg/L |
| 혐기조 pH | 0.85~0.90 | 0.80~0.85 | 2~4% | 0.2~0.3 |
| 혐기조 DO | 0.85~0.90 | 0.80~0.85 | 10~15% | 0.05~0.1 mg/L |

### 3. 성능 모니터링 기준

#### 정기 재학습 주기
- **기본**: 30일마다 재학습
- **이유**: 계절별 수온 변화 및 미생물 군집 변화 대응

#### 조기 재학습 기준
- **MAPE > 20%**: 모델 성능 저하 감지 시 즉시 재학습
- **연속 3일 이상 예측 오차 증가**: 트렌드 변화 감지

#### 알림 기준
- **Warning**: MAPE 15~20% (주의 필요)
- **Critical**: MAPE > 20% (재학습 필요)

---

## 참고 문서

- **모델 코드**: [model.ipynb](model.ipynb) (작성 예정)
- **리뷰 문서**: [review.md](review.md)
- **유입수 모델 참조**: [../01 유입수/req002_model.ipynb](../01%20유입수/req002_model.ipynb)

---

**문의**: 모델 관련 문의사항은 AI팀으로 연락 바랍니다.
**최종 수정일**: 2025-11-21
